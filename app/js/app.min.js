document.addEventListener("DOMContentLoaded",(function(){let e=document.getElementById("table"),t=document.getElementById("delete"),s=document.getElementById("clear"),n=document.getElementById("add"),l=document.getElementById("host"),r=document.getElementById("file"),a=document.getElementById("download"),d=document.getElementsByTagName("body").item(0),o=document.getElementsByTagName("header").item(0),i=document.getElementsByTagName("main").item(0),h=document.getElementById("container"),m=[],c=0;a.onclick=e=>{u("lpu.json")};let u=e=>{let t=document.createElement("a"),s=p.getData();t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(s)),t.setAttribute("download",e),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)};class g{constructor(e){return document.createElement(e)}static setClass=(e,t)=>{e.setAttribute("class",t)};static setId=(e,t)=>{e.setAttribute("id",t)};static setPlaceholder=(e,t)=>{e.setAttribute("placeholder",t)}}let p=new class{storage={};constructor(){this.storage=window.localStorage}getItem=e=>window.localStorage.getItem(e);names={};phones={};addresses={};setNames=e=>{this.names=e};setPhones=e=>{this.phones=e};setAddresses=e=>{this.addresses=e};refreshStorage=()=>{this.storage.setItem("names",JSON.stringify(this.names)),this.storage.setItem("phones",JSON.stringify(this.phones)),this.storage.setItem("addresses",JSON.stringify(this.addresses))};updateStorage=(e,t,s)=>{let n={},l={},r="",a="";switch(t){case"full_name":l=this.phones,r=N(s),n=this.names,a=B(s);break;case"address":l=this.names,r=E(s),n=this.addresses,a=N(s);break;case"phone":l=this.addresses,r=B(s),a=E(s),n=this.phones}l[r]=e;let d=Object.keys(n);for(let t=0;t<d.length;t++)n[d[t]]===a&&(delete n[d[t]],n[e]=a);this.refreshStorage()};isUnique=(e,t)=>{switch(e){case"full_name":return!Boolean(this.names[t]);case"phone":return!Boolean(this.phones[t]);case"address":return!Boolean(this.addresses[t])}};updateNameByPhone=(e,t)=>{this.phones[e]=t};updateAddressByName=(e,t)=>{this.names[e]=t};updatePhoneByAddress=(e,t)=>{this.addresses[e]=t};addNewRecord=(e,t,s)=>{p.updateNameByPhone(t,e),p.updateAddressByName(e,s),p.updatePhoneByAddress(s,t),p.refreshStorage()};deleteData=e=>{delete this.phones[N(e)],delete this.addresses[B(e)],delete this.names[E(e)]};clean=()=>{window.localStorage.clear(),this.setNames({}),this.setPhones({}),this.setAddresses({}),this.refreshStorage()};getData=()=>{let e=[],t=Object.keys(this.addresses);for(let s=0;s<t.length;s++){let n=t[s],l=this.addresses[n],r=this.phones[l];e.push({full_name:r,phone:l,address:n})}return JSON.stringify(e)}};r.onchange=t=>{let s=t.target.files[0],n=new FileReader;n.onload=function(t){let s=t.target.result,n=JSON.parse(s);p.clean(),console.log(p),n.forEach(e=>{let t=e.full_name,s=e.phone,n=e.address;p.addNewRecord(t,s,n)});let l=e.getElementsByTagName("tr");for(let t=l.length-1;t>0;t--)e.removeChild(l.item(t));I()},n.onerror=function(e){console.error("Файл не может быть прочитан! код "+e.target.error.code)},n.readAsText(s)};let f=t=>{m=[];let s=e.getElementsByTagName("tr");for(let e=0;e<s.length;e++){let t=s.item(e);t.removeAttribute("style"),t.removeAttribute("selected")}};s.onclick=e=>{f()},t.onclick=t=>{m=[];let s=[],n=e.getElementsByTagName("tr");for(let e=0;e<n.length;e++){let t=n.item(e);null!==t.getAttribute("selected")&&(s.push(t),p.deleteData(t),p.refreshStorage())}s.forEach(t=>{e.removeChild(t)}),1===n.length&&b()};let y=(e,t)=>{d.removeChild(t),i.style.filter="",o.style.filter=""};n.onclick=e=>{let t=new g("div");g.setClass(t,"modal");let s=new g("form"),n=new g("span");g.setClass(n,"heading"),n.innerText="Add new info",s.appendChild(n);let l=new g("input");g.setId(l,"full_name"),g.setPlaceholder(l,"Name"),l.setAttribute("autocomplete","off"),s.appendChild(l),l=new g("input"),g.setId(l,"phone"),l.setAttribute("type","phone"),g.setPlaceholder(l,"Phone"),l.setAttribute("autocomplete","off"),s.appendChild(l),l=new g("input"),g.setId(l,"address"),g.setPlaceholder(l,"Address"),l.setAttribute("autocomplete","off"),s.appendChild(l),s.focus(),s.onmouseleave=e=>{y(0,t)};let r=new g("button");r.innerText="Add",r.onclick=e=>((e,t)=>{e.preventDefault();let s=!0,n=t.getElementsByTagName("input"),l={};for(let e=0;e<n.length;e++){let r=n.item(e),a=r.getAttribute("id"),d=r.value,o=new g("span");g.setClass(o,"error");let i=t.getElementsByTagName("span");if(r.style.borderColor="black",i.length>1&&t.removeChild(i.item(i.length-1)),0===d.length){s=!1,o.innerText="Empty field",r.style.borderBottomColor="red",t.appendChild(o);break}if(!p.isUnique(a,d)){s=!1,o.innerText=a.charAt(0).toUpperCase()+a.substring(1)+" is not unique",r.style.borderBottomColor="red",t.appendChild(o);break}l[a]=d}s&&(0===p.getItem("addresses").length&&A(),p.addNewRecord(l.full_name,l.phone,l.address),p.refreshStorage(),w({full_name:l.full_name,phone:l.phone,address:l.address}),y(0,t))})(e,t),s.appendChild(r),t.appendChild(s),i.style.transition="0.7s all linear",i.style.filter="blur(10px)",o.style.transition="0.7s all linear",o.style.filter="blur(10px)",d.appendChild(t)};let b=()=>{if(1===h.getElementsByTagName("table").length){h.removeChild(e);let n=document.createElement("div"),l=document.createElement("h2");n.appendChild(l),l.innerText="There`s no info... Add some!",h.appendChild(n),t.setAttribute("disabled",""),s.setAttribute("disabled","")}},A=()=>{0!==h.getElementsByTagName("div").length&&(h.removeChild(h.getElementsByTagName("div").item(0)),h.appendChild(e))},C=(e,t)=>e.getElementsByTagName("td")[t],E=e=>C(e,0).innerText,B=e=>C(e,2).innerText,N=e=>C(e,1).innerText,T=(t,s,n)=>{let l=t.target,r=(t=>e.getElementsByTagName("tr")[parseInt(t)+1])(n),a=C(r,s),d=l.value,o=a.getAttribute("key");d.length>0&&(p.updateStorage(d,o,r),a.removeChild(l),a.innerText=d)},w=t=>{let s=document.createElement("tr");s.onclick=e=>{(e=>{let t=e.currentTarget,s=t.getAttribute("selected"),n=t.style,l=t.getElementsByTagName("td")[0].getAttribute("vertIndex");null===s?(n.backgroundColor="#89099c",n.color="white",t.setAttribute("selected",""),m.push(l)):(n.backgroundColor="transparent",n.color="black",t.removeAttribute("selected"),m=m.filter(e=>e!==l))})(e)},Object.keys(t).forEach((e,n)=>{let l=document.createElement("td");l.innerText=t[e],l.setAttribute("horIndex",n),l.setAttribute("vertIndex",c),l.setAttribute("key",e),l.ondblclick=e=>{(e=>{f();let t=e.target,s=t.getAttribute("vertIndex"),n=t.getAttribute("horIndex"),l=document.createElement("input");l.value=t.innerText,l.onblur=e=>{T(e,n,s)},t.innerText="",t.appendChild(l),l.focus()})(e)},s.appendChild(l)}),e.appendChild(s),c++},I=()=>{A();let e=JSON.parse(p.getItem("names"));null===e&&(e={}),p.setNames(e);let t=JSON.parse(p.getItem("phones"));null===t&&(t={}),p.setPhones(t);let s=JSON.parse(p.getItem("addresses"));null===s&&(s={}),p.setAddresses(s);let n=Object.keys(s);for(let e=0;e<n.length;e++){let l=n[e],r=s[l],a=t[r];w({full_name:a,phone:r,address:l})}0!==c&&0!==p.length||b()};l.onclick=t=>{t.preventDefault();let s=e.getElementsByTagName("tr");if(1===s.length)b();else if(s.length>1)for(let t=1;t<s.length;t++)e.removeChild(s.item(t));A(),fetch("https://whatruska.github.io/Bars_Group_Test/app/lpu.json").then(e=>e.json()).then(e=>{e.forEach(e=>{let t=e.address,s=e.phone,n=e.full_name;w(e),p.addNewRecord(n,s,t)}),p.refreshStorage(),window.location.reload()})},I()}));