"use strict";document.addEventListener("DOMContentLoaded",(function(){let e=document.getElementById("table"),t=e.getElementsByClassName("table-row"),s=document.getElementsByTagName("body").item(0),l=document.getElementsByTagName("header").item(0),r=document.getElementsByTagName("main").item(0),n=document.getElementById("container"),o=document.getElementById("delete"),a=document.getElementById("clear"),d=document.getElementById("add"),i=document.getElementById("host"),h=document.getElementById("file"),c=document.getElementById("download"),m=[],u=0;class g{constructor(e){return document.createElement(e)}static setClass=(e,t)=>{e.setAttribute("class",t)};static setId=(e,t)=>{e.setAttribute("id",t)};static setPlaceholder=(e,t)=>{e.setAttribute("placeholder",t)}}let p=new class{storage={};constructor(){this.storage=window.localStorage}getItem=e=>window.localStorage.getItem(e);names={};phones={};addresses={};setNames=e=>{this.names=e};setPhones=e=>{this.phones=e};setAddresses=e=>{this.addresses=e};refreshStorage=()=>{this.storage.setItem("names",JSON.stringify(this.names)),this.storage.setItem("phones",JSON.stringify(this.phones)),this.storage.setItem("addresses",JSON.stringify(this.addresses))};updateStorage=(e,t,s)=>{let l={},r={},n="",o="";switch(t){case"full_name":r=this.phones,n=v(s),l=this.names,o=E(s);break;case"address":r=this.names,n=w(s),l=this.addresses,o=v(s);break;case"phone":r=this.addresses,n=E(s),o=w(s),l=this.phones}r[n]=e;for(let t in l)l[t]===o&&(delete l[t],l[e]=o);this.refreshStorage()};isUnique=(e,t)=>{switch(e){case"full_name":return!Boolean(this.names[t]);case"phone":return!Boolean(this.phones[t]);case"address":return!Boolean(this.addresses[t])}};updateNameByPhone=(e,t)=>{this.phones[e]=t};updateAddressByName=(e,t)=>{this.names[e]=t};updatePhoneByAddress=(e,t)=>{this.addresses[e]=t};addNewRecord=(e,t,s)=>{p.updateNameByPhone(t,e),p.updateAddressByName(e,s),p.updatePhoneByAddress(s,t),p.refreshStorage()};deleteData=e=>{delete this.phones[v(e)],delete this.addresses[E(e)],delete this.names[w(e)]};clean=()=>{window.localStorage.clear(),this.setNames({}),this.setPhones({}),this.setAddresses({}),this.refreshStorage()};getData=()=>{let e=[];for(let t in this.addresses){let s=this.addresses[t],l=this.phones[s];e.push({full_name:l,phone:s,address:t})}return JSON.stringify(e)}},b=e=>{m=[];for(let e=0;e<t.length;e++){let s=t.item(e);s.removeAttribute("style"),s.removeAttribute("selected");let l=[...t].indexOf(s);l%2==0&&0!==l&&(s.style.backgroundColor="gray",s.style.color="white")}},y=(e,t)=>{s.removeChild(t),r.style.filter="",l.style.filter=""},f=()=>{if(5===n.getElementsByTagName("div").length){n.removeChild(e);let t=document.createElement("div");g.setId(t,"slide");let s=document.createElement("h2");t.appendChild(s),s.innerText="There`s no info... Add some!",n.appendChild(t),o.setAttribute("disabled",""),a.setAttribute("disabled","")}},C=()=>{let t=document.getElementById("slide");t&&(n.removeChild(t),n.appendChild(e))},A=(e,t)=>e.getElementsByTagName("div")[t],w=e=>A(e,0).innerText,E=e=>A(e,2).innerText,v=e=>A(e,1).innerText,B=(e,s,l)=>{let r=e.target,n=(e=>(console.log(t),t[parseInt(e)+1]))(l),o=A(n,s),a=r.value,d=o.getAttribute("key");a.length>0&&(p.updateStorage(a,d,n),o.removeChild(r),o.innerText=a),N()},N=e=>{0===m.length?(o.setAttribute("disabled",""),a.setAttribute("disabled","")):(o.removeAttribute("disabled"),a.removeAttribute("disabled"))},k=s=>{let l=document.createElement("div");g.setClass(l,"row table-row"),l.onclick=e=>{(e=>{let s=e.currentTarget,l=s.getAttribute("selected"),r=s.style,n=s.getElementsByTagName("div")[0].getAttribute("vertIndex");if(null===l)r.backgroundColor="#89099c",r.color="white",s.setAttribute("selected",""),m.push(n);else{r.backgroundColor="transparent",r.color="black",[...t].indexOf(s)%2==0&&(r.backgroundColor="gray",r.color="white"),s.removeAttribute("selected"),m=m.filter(e=>e!==n)}N()})(e)},Object.keys(s).forEach((e,t)=>{let r=document.createElement("div");g.setClass(r,"table-item"),r.innerText=s[e],r.setAttribute("horIndex",t),r.setAttribute("vertIndex",u),r.setAttribute("key",e),r.ondblclick=e=>{(e=>{b(),N();let t=e.target,s=t.getAttribute("vertIndex"),l=t.getAttribute("horIndex"),r=document.createElement("input");if(r.value=t.innerText,s%2!=0){let e=r.style;e.backgroundColor="gray",e.color="white",e.borderColor="white"}r.onblur=e=>{B(e,l,s)},t.innerText="",t.appendChild(r),r.focus()})(e)},l.appendChild(r)}),e.appendChild(l),t.length%2!=0&&(l.style.backgroundColor="gray",l.style.color="white"),u++},T=()=>{C();let e=JSON.parse(p.getItem("names"));null===e&&(e={}),p.setNames(e);let t=JSON.parse(p.getItem("phones"));null===t&&(t={}),p.setPhones(t);let s=JSON.parse(p.getItem("addresses"));null===s&&(s={}),p.setAddresses(s);for(let e in s){let l=s[e],r=t[l];k({full_name:r,phone:l,address:e})}0!==u&&0!==p.length||f()},I=t=>{t.preventDefault();let s=e.getElementsByTagName("tr");if(1===s.length)f();else if(s.length>1)for(let t=1;t<s.length;t++)e.removeChild(s.item(t));C(),(()=>{let e=new XMLHttpRequest;e.onload=function(e){e.currentTarget.response.forEach(e=>{let t=e.address,s=e.phone,l=e.full_name;p.addNewRecord(l,s,t)})},e.open("GET","https://whatruska.github.io/Bars_Group_Test/app/lpu.json"),e.responseType="json",e.send(),p.refreshStorage(),window.location.reload()})()};N(),i.onclick=I,d.onclick=e=>{let t=new g("div");g.setClass(t,"modal");let n=new g("form"),o=new g("span");g.setClass(o,"heading"),o.innerText="Add new info",n.appendChild(o);let a=(e,t)=>{let s=new g("input");return g.setId(s,e),g.setPlaceholder(s,t),s.setAttribute("autocomplete","off"),n.appendChild(s),s};a("full_name","Name"),a("phone","Phone").setAttribute("type","phone"),a("address","Address"),n.focus(),n.onmouseleave=e=>{y(0,t)};let d=new g("button");d.innerText="Add",d.onclick=e=>((e,t)=>{e.preventDefault();let s=!0,l=t.getElementsByTagName("input"),r={};for(let e=0;e<l.length;e++){let n=l.item(e),o=n.getAttribute("id"),a=n.value,d=new g("span");g.setClass(d,"error");let i=t.getElementsByTagName("span");if(n.style.borderColor="black",i.length>1&&t.removeChild(i.item(i.length-1)),0===a.length){s=!1,d.innerText="Empty field",n.style.borderBottomColor="red",t.appendChild(d);break}if(!p.isUnique(o,a)){s=!1,d.innerText=o.charAt(0).toUpperCase()+o.substring(1)+" is not unique",n.style.borderBottomColor="red",t.appendChild(d);break}r[o]=a}s&&(C(),p.addNewRecord(r.full_name,r.phone,r.address),p.refreshStorage(),k({full_name:r.full_name,phone:r.phone,address:r.address}),y(0,t))})(e,t),n.appendChild(d),t.appendChild(n),r.style.transition="0.7s all linear",r.style.filter="blur(10px)",l.style.transition="0.7s all linear",l.style.filter="blur(10px)",s.appendChild(t)},a.onclick=e=>{b(),N(e)},o.onclick=s=>{m=[];let l=[],r=[...t];for(let e=0;e<r.length;e++){let t=r[e];null!==t.getAttribute("selected")&&(l.push(t),p.deleteData(t),p.refreshStorage())}l.forEach(t=>{e.removeChild(t)}),r=[...t],1===r.length&&f(),[...t].forEach((e,t)=>{[...e.getElementsByTagName("div")].forEach(e=>{e.setAttribute("vertIndex",t-1)}),0===t?(e.style.color="white",e.style.backgroundColor="black"):t%2==0?(e.style.color="white",e.style.backgroundColor="grey"):(e.style.color="black",e.style.backgroundColor="white")}),N(s)},h.onchange=s=>{let l=s.target.files[0],r=new FileReader;r.onload=function(s){let l=s.target.result,r=JSON.parse(l);p.clean(),r.forEach(e=>{let t=e.full_name,s=e.phone,l=e.address;p.addNewRecord(t,s,l)}),(()=>{for(let s=t.length-1;s>0;s--)e.removeChild(t.item(s))})(),T()},r.onerror=function(e){console.error("Файл не может быть прочитан! код "+e.target.error.code)},r.readAsText(l)},c.onclick=e=>{(e=>{let t=document.createElement("a"),s=p.getData();t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(s)),t.setAttribute("download",e),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)})("lpu.json")},T()}));